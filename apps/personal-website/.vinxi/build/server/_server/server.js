import{AsyncLocalStorage as M}from"node:async_hooks";import{H3Event as _,getRequestURL as U,getRequestWebStream as W,getResponseStatus as J,eventHandler as B}from"h3";var K="Invariant failed";function V(e,t){if(!e)throw new Error(K)}function v(e){if(!O(e))return!1;const t=e.constructor;if(typeof t>"u")return!0;const n=t.prototype;return!(!O(n)||!n.hasOwnProperty("isPrototypeOf"))}function O(e){return Object.prototype.toString.call(e)==="[object Object]"}function F(e){return!!e?.isNotFound}function L(e){return!!e?.isRedirect}const l={stringify:e=>JSON.stringify(e,function(n,r){const o=this[n],a=S.find(s=>s.stringifyCondition(o));return a?a.stringify(o):r}),parse:e=>JSON.parse(e,function(n,r){const o=this[n];if(v(o)){const a=S.find(s=>s.parseCondition(o));if(a)return a.parse(o)}return r}),encode:e=>{if(Array.isArray(e))return e.map(n=>l.encode(n));if(v(e))return Object.fromEntries(Object.entries(e).map(([n,r])=>[n,l.encode(r)]));const t=S.find(n=>n.stringifyCondition(e));return t?t.stringify(e):e},decode:e=>{if(v(e)){const t=S.find(n=>n.parseCondition(e));if(t)return t.parse(e)}return Array.isArray(e)?e.map(t=>l.decode(t)):v(e)?Object.fromEntries(Object.entries(e).map(([t,n])=>[t,l.decode(n)])):e}},y=(e,t,n,r)=>({key:e,stringifyCondition:t,stringify:o=>({[`$${e}`]:n(o)}),parseCondition:o=>Object.hasOwn(o,`$${e}`),parse:o=>r(o[`$${e}`])}),S=[y("undefined",e=>e===void 0,()=>0,()=>{}),y("date",e=>e instanceof Date,e=>e.toISOString(),e=>new Date(e)),y("error",e=>e instanceof Error,e=>({...e,message:e.message,stack:void 0,cause:e.cause}),e=>Object.assign(new Error(e.message),e)),y("formData",e=>e instanceof FormData,e=>{const t={};return e.forEach((n,r)=>{const o=t[r];o!==void 0?Array.isArray(o)?o.push(n):t[r]=[o,n]:t[r]=n}),t},e=>{const t=new FormData;return Object.entries(e).forEach(([n,r])=>{Array.isArray(r)?r.forEach(o=>t.append(n,o)):t.append(n,r)}),t}),y("bigint",e=>typeof e=="bigint",e=>e.toString(),e=>BigInt(e))];function G(e={}){let t,n=!1;const r=s=>{if(t&&t!==s)throw new Error("Context conflict")};let o;if(e.asyncContext){const s=e.AsyncLocalStorage||globalThis.AsyncLocalStorage;s?o=new s:console.warn("[unctx] `AsyncLocalStorage` is not provided.")}const a=()=>{if(o){const s=o.getStore();if(s!==void 0)return s}return t};return{use:()=>{const s=a();if(s===void 0)throw new Error("Context is not available");return s},tryUse:()=>a(),set:(s,c)=>{c||r(s),t=s,n=!0},unset:()=>{t=void 0,n=!1},call:(s,c)=>{r(s),t=s;try{return o?o.run(s,c):c()}finally{n||(t=void 0)}},async callAsync(s,c){t=s;const g=()=>{t=s},f=()=>t===s?g:void 0;$.add(f);try{const d=o?o.run(s,c):c();return n||(t=void 0),await d}finally{$.delete(f)}}}}function Q(e={}){const t={};return{get(n,r={}){return t[n]||(t[n]=G({...e,...r})),t[n]}}}const C=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof global<"u"?global:typeof window<"u"?window:{},q="__unctx__",X=C[q]||(C[q]=Q()),Y=(e,t={})=>X.get(e,t),N="__unctx_async_handlers__",$=C[N]||(C[N]=new Set);function Z(e){let t;const n=D(e),r={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(n,{...r,body:e.node.req.body}):new Request(n,{...r,get body(){return t||(t=re(e),t)}})}function k(e){return e.web??(e.web={request:Z(e),url:D(e)}),e.web.request}function ee(){return H()}const P=Symbol("$HTTPEvent");function te(e){return typeof e=="object"&&(e instanceof _||e?.[P]instanceof _||e?.__is_event__===!0)}function E(e){return function(...t){var n;const r=t[0];if(te(r))t[0]=r instanceof _||r.__is_event__?r:r[P];else{if(!((n=globalThis.app.config.server.experimental)!=null&&n.asyncContext))throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");t.unshift(ee())}return e(...t)}}const D=E(U),ne=E(J),re=E(W);function oe(){var e;return Y("nitro-app",{asyncContext:!!((e=globalThis.app.config.server.experimental)!=null&&e.asyncContext),AsyncLocalStorage:M})}function H(){const e=oe().use().event;if(!e)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");return e}const se={},le=B(ie),b=se;async function ie(e){const t=k(e);return await ce({request:t,event:e})}function ae(e){return e.replace(/^\/|\/$/g,"")}async function ce({request:e,event:t}){const n=new AbortController,r=n.signal,o=()=>n.abort();t.node.req.on("close",o);const a=e.method,s=new URL(e.url,"http://localhost:3000"),c=new RegExp(`${ae("/_server")}/([^/?#]+)`),g=s.pathname.match(c),f=g?g[1]:null,d=Object.fromEntries(s.searchParams.entries()),x="createServerFn"in d,I="raw"in d;if(typeof f!="string")throw new Error("Invalid server action param for serverFnId: "+f);const R=b[f];if(!R)throw console.log("serverFnManifest",b),new Error("Server function info not found for "+f);let w;if(w=await R.importer(),!w)throw console.log("serverFnManifest",b),new Error("Server function module not resolved for "+f);const p=w[R.functionName];if(!p)throw console.log("serverFnManifest",b),console.log("fnModule",w),new Error(`Server function module export not resolved for serverFn ID: ${f}`);const z=["multipart/form-data","application/x-www-form-urlencoded"],h=await(async()=>{try{let i=await(async()=>{if(e.headers.get("Content-Type")&&z.some(u=>{var A;return(A=e.headers.get("Content-Type"))==null?void 0:A.includes(u)}))return V(a.toLowerCase()!=="get","GET requests with FormData payloads are not supported"),await p(await e.formData(),r);if(a.toLowerCase()==="get"){let u=d;return x&&(u=d.payload),u=u&&l.parse(u),await p(u,r)}const m=await e.text(),T=l.parse(m);return x?await p(T,r):await p(...T,r)})();return i.result instanceof Response?i.result:!x&&(i=i.result,i instanceof Response)?i:L(i)||F(i)?j(i):new Response(i!==void 0?l.stringify(i):void 0,{status:ne(H()),headers:{"Content-Type":"application/json"}})}catch(i){return i instanceof Response?i:L(i)||F(i)?j(i):(console.info(),console.info("Server Fn Error!"),console.info(),console.error(i),console.info(),new Response(l.stringify(i),{status:500,headers:{"Content-Type":"application/json"}}))}})();if(t.node.req.removeListener("close",o),I)return h;if(h.headers.get("Content-Type")==="application/json"){const m=await h.clone().text();m&&JSON.stringify(JSON.parse(m))}return h}function j(e){const{headers:t,...n}=e;return new Response(JSON.stringify(n),{status:200,headers:{"Content-Type":"application/json",...t||{}}})}export{le as default};
